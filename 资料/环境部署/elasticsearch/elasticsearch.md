https://blog.csdn.net/qq_33816243/article/details/132173142

创建网络
docker network create es --subnet=172.18.0.0/16

自己创建数据卷目录并授权

```
mkdir -p  /elastic/es8/data
mkdir -p  /elastic/es8/plugins
mkdir -p  /elastic/es8/logs
```

chmod 777   /elastic/es8/config
chmod 777   /elastic/es8/data
chmod 777   /elastic/es8/plugins
chmod 777   /elastic/es8/logs

config目录还是不要映射了。容器可能启动失败，启动的时候可能找不到配置，因为/elastic/es8/config还是空的
-v /elastic/es8/config:/usr/share/elasticsearch/config \这行不加，需要配置的进入容器查看
启动es容器--

```
docker run \
--name es8 \
--net es \
--ip 172.18.0.3 \
--privileged=true \
-p 9200:9200 \
-p 9300:9300 \
-v  /elastic/es8/data:/usr/share/elasticsearch/data \
-v  /elastic/es8/plugins:/usr/share/elasticsearch/plugins \
-v  /elastic/es8/logs:/usr/share/elasticsearch/logs \
-e ES_JAVA_OPTS="-Xms512m -Xmx512m" \
-e "discovery.type=single-node" \
-d --restart always  \
myes8:1.0
elasticsearch:8.2.0
```





启动Kibana容器-----以下是两个镜像
docker run --name kibana -d  --net es   -p 5601:5601 kibana:8.2.0



初始化配置
es生成kibana的连接token
docker exec -it es8 bash
es8@a15632b27a31:~$ elasticsearch-create-enrollment-token --scope kibana
eyJ2ZXIiOiI4LjguMiIsImFkciI6WyIxNzIuMTkuMC4xMDA6OTIwMCJdLCJmZ3IiOiI4NzNjYjMwNTQzODBkODRhNDcwMTcxMzQ0Mzc4ZDFmYmYxNmI2OTc2ODlkZjM1MGU1ZWM3OWJjYWIxNDgwNTI5Iiwia2V5IjoiLWp4MWtJa0I5T25GdkhMN2NsNGk6VHRoYWYxVTlUQS1BVVcwbGlwbEplUSJ9



登录Kibana，填写token完成es连接
kibana生成二次验证码
docker exec -it kibana /bin/bash       
kibana@1b35739cdeed:~$ kibana-verification-code
Your verification code is:  471 593

kibana填写二次验证码---kibana连接登录es成功

es生成初始化密码
docker exec -it es8 /bin/bash
es8@a15632b27a31:~$ elasticsearch-reset-password -u elastic
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y

Password for the [elastic] user successfully reset.
New value: ANrjs2w+upw0O1a1Yuka

kibana填写es账号密码登录


安装完es后，自动为我们配置了用户密码和tls证书,用curl测试
curl -k -u 'elastic:7z*to5bN_*YCQ89ZgqKm' https://192.168.121.121:9200/_cat/nodes?v

修改 es8:/usr/share/elasticsearch/config/elasticsearch.yml 添加如下内容支持跨域
http.cors.enabled: true
http.cors.allow-origin: "*"

#es_head连接时读取用户名密码
http.cors.allow-headers:
Authorization,X-Requested-With,Content-Length,Content-Type

ES证书导出
使用logstash或者filebeat，SDK连接es时，如果不指定ca证书，会提示x509错误，需要提前导出ca证书。
docker  cp  es8:/usr/share/elasticsearch/config/certs .  

ls certs                                            
http.p12      http_ca.crt   transport.p12




错误总结
es   docker容器启动失败，config目录不要挂载出来，挂载出来后，容器刚启动会去虚拟机查找配置文件，刚开始肯定是空的，结果启动失败，不挂载出来则会查找容器自带的配置文件，要修改配置文件时用docker cp 命令复制出来，改完再复制回去，重启容器

es容器启动后浏览器访问失败，检查防火墙端口是否开放，如果直接访问192.168.121.121:9200肯定会失败，es8开启安全模式，这个地址是
http://192.168.121.121:9200的简写，需要访问https://192.168.121.121:9200

安装完成后将目录下的ik分词器放到es的plugins目录下，重启容器就可以使用了。
